<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 做中學 Cycle.js（下） · De-bug</title><meta name="description" content="做中學 Cycle.js（下） - Tsung-Chen Ku"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/abalone0204" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">做中學 Cycle.js（下）</h1><div class="post-time">Feb 1, 2016</div><div class="post-content"><p>Model-View-Intent &amp; Component</p>
<a id="more"></a>
<h1 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h1><p>我們會希望寫出來的 code 能夠做成被複用的 Component，</p>
<p>不過首先要來拆解一下越來越肥大的 main function。</p>
<p>而 main 就可以被拆成 Model、View 、Intent。</p>
<h1 id="Model-View-Intent"><a href="#Model-View-Intent" class="headerlink" title="Model View Intent"></a>Model View Intent</h1><p>先看一下上次 BMI example 的 main function</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params">sources</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> changeWeight$ = sources.DOM.select(<span class="string">'.weight'</span>).events(<span class="string">'input'</span>)</span><br><span class="line">        .map(ev =&gt; ev.target.value).startWith(<span class="number">70</span>);</span><br><span class="line">    <span class="keyword">const</span> changeHeight$ = sources.DOM.select(<span class="string">'.height'</span>).events(<span class="string">'input'</span>)</span><br><span class="line">        .map(ev =&gt; ev.target.value).startWith(<span class="number">170</span>);</span><br><span class="line">    <span class="keyword">const</span> state$ = Rx.Observable.combineLatest(</span><br><span class="line">        changeWeight$,</span><br><span class="line">        changeHeight$, (weight, height) =&gt; &#123;</span><br><span class="line">            <span class="keyword">const</span> heightM = height/<span class="number">100</span>;</span><br><span class="line">            <span class="keyword">const</span> bmi = <span class="built_in">Math</span>.round(weight / (heightM * heightM));</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                bmi, weight, height</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        DOM: state$.map(state =&gt;</span><br><span class="line">            div([</span><br><span class="line">                div([</span><br><span class="line">                    label(<span class="string">`Weight: <span class="subst">$&#123;state.weight&#125;</span>kg`</span>),</span><br><span class="line">                    input(<span class="string">'.weight'</span>, &#123;</span><br><span class="line">                        type: <span class="string">'range'</span>,</span><br><span class="line">                        min: <span class="number">40</span>,</span><br><span class="line">                        max: <span class="number">150</span>,</span><br><span class="line">                        value: state.weight</span><br><span class="line">                    &#125;)</span><br><span class="line">                ]),</span><br><span class="line">                div([</span><br><span class="line">                    label(<span class="string">`Height: <span class="subst">$&#123;state.height&#125;</span>cm`</span>),</span><br><span class="line">                    input(<span class="string">'.height'</span>, &#123;</span><br><span class="line">                        type: <span class="string">'range'</span>,</span><br><span class="line">                        min: <span class="number">140</span>,</span><br><span class="line">                        max: <span class="number">250</span>,</span><br><span class="line">                        value: state.height</span><br><span class="line">                    &#125;)</span><br><span class="line"></span><br><span class="line">                ]),</span><br><span class="line">                h1(<span class="string">`BMI is <span class="subst">$&#123;state.bmi&#125;</span>`</span>)</span><br><span class="line">            ])</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這麼大一包看起來絕對不是好事。</p>
<p>所以我們會把 main 分成三塊，</p>
<p>分別是 Model, Intent, View</p>
<ul>
<li><p>Intent: to listen to the user</p>
</li>
<li><p>Model: to process information </p>
</li>
<li><p>View: to output back to the user</p>
</li>
</ul>
<h2 id="Intent"><a href="#Intent" class="headerlink" title="Intent"></a>Intent</h2><p>第一塊是「Intent」，</p>
<p>簡單說就是 User 想對 UI 做什麼事情的 Intent，</p>
<p>在這裡當然就是指雙方互動的部分：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input event 就是這個簡單 app 中 User 跟 UI 互動的部分</span></span><br><span class="line"><span class="keyword">const</span> changeWeight$ = sources.DOM.select(<span class="string">'.weight'</span>).events(<span class="string">'input'</span>)</span><br><span class="line">        .map(ev =&gt; ev.target.value).startWith(<span class="number">70</span>);</span><br><span class="line"><span class="keyword">const</span> changeHeight$ = sources.DOM.select(<span class="string">'.height'</span>).events(<span class="string">'input'</span>)</span><br><span class="line">        .map(ev =&gt; ev.target.value).startWith(<span class="number">170</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">intent</span> (<span class="params">DOMSource</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> changeWeight$ = DOMSource.select(<span class="string">'.weight'</span>).events(<span class="string">'input'</span>)</span><br><span class="line">        .map(ev =&gt; ev.target.value).startWith(<span class="number">70</span>);</span><br><span class="line">    <span class="keyword">const</span> changeHeight$ = DOMSource.select(<span class="string">'.height'</span>).events(<span class="string">'input'</span>)</span><br><span class="line">        .map(ev =&gt; ev.target.value).startWith(<span class="number">170</span>);</span><br><span class="line">    <span class="keyword">return</span> &#123;changeWeight$,changeHeight$&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h2><p>model 則是處理資料流的部分：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">model</span>(<span class="params">changeWeight$, changeHeight$</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> state$ = Rx.Observable.combineLatest(</span><br><span class="line">        changeWeight$,</span><br><span class="line">        changeHeight$, (weight, height) =&gt; &#123;</span><br><span class="line">            <span class="keyword">const</span> heightM = height/<span class="number">100</span>;</span><br><span class="line">            <span class="keyword">const</span> bmi = <span class="built_in">Math</span>.round(weight / (heightM * heightM));</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                bmi, weight, height</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">return</span> state$;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="View"><a href="#View" class="headerlink" title="View"></a>View</h2><p>這裏則是依照 Model 中的資料去建 Virtual DOM tree</p>
<blockquote>
<p>我們不會把最後要 return 給 Driver 的東西也放在這</p>
<p>僅放跟 UI 生成相關的而已</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">view</span>(<span class="params">state$</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> vtree$ = state$.map(state =&gt;</span><br><span class="line">            div([</span><br><span class="line">                div([</span><br><span class="line">                    label(<span class="string">`Weight: <span class="subst">$&#123;state.weight&#125;</span>kg`</span>),</span><br><span class="line">                    input(<span class="string">'.weight'</span>, &#123;</span><br><span class="line">                        type: <span class="string">'range'</span>,</span><br><span class="line">                        min: <span class="number">40</span>,</span><br><span class="line">                        max: <span class="number">150</span>,</span><br><span class="line">                        value: state.weight</span><br><span class="line">                    &#125;)</span><br><span class="line">                ]),</span><br><span class="line">                div([</span><br><span class="line">                    label(<span class="string">`Height: <span class="subst">$&#123;state.height&#125;</span>cm`</span>),</span><br><span class="line">                    input(<span class="string">'.height'</span>, &#123;</span><br><span class="line">                        type: <span class="string">'range'</span>,</span><br><span class="line">                        min: <span class="number">140</span>,</span><br><span class="line">                        max: <span class="number">250</span>,</span><br><span class="line">                        value: state.height</span><br><span class="line">                    &#125;)</span><br><span class="line"></span><br><span class="line">                ]),</span><br><span class="line">                h1(<span class="string">`BMI is <span class="subst">$&#123;state.bmi&#125;</span>`</span>)</span><br><span class="line">            ])</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> vtree$;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="MVI"><a href="#MVI" class="headerlink" title="MVI"></a>MVI</h2><p>然後我們的 main 變得簡潔許多，</p>
<p>看起來只是 function 組合起來而已:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params">sources</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;changeWeight$,changeHeight$&#125; = intent(sources.DOM);</span><br><span class="line">    <span class="keyword">const</span> state$ = model(changeWeight$, changeHeight$);</span><br><span class="line">    <span class="keyword">const</span> vtree$ = view(state$);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        DOM: vtree$</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Component"><a href="#Component" class="headerlink" title="Component"></a>Component</h2><p>那我們該如何減少重複的 Code 呢？</p>
<p>當 UI 的操作越變越複雜以後，</p>
<p>我們不會希望所有事情都能在一個 main 裡面解決，</p>
<p>這時候我們可以把重複的部分抽出來變成 component。</p>
<p>egghead 課程裡面有更精簡的怎麼把 main 提煉成 component 的過程，</p>
<p>不過核心精神蠻簡單的，就是 <strong>props 也是 stream。</strong></p>
<p>因為 props 是會跟著傳下來的「資料」，</p>
<p>所以很自然的我們就會選擇處理資料的 model 下手。</p>
<p>而 model 收到的 sources 是從 Drivers 來的，</p>
<p>第一步就是先更動 drivers</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> drivers = &#123;</span><br><span class="line">    DOM: makeDOMDriver(<span class="string">'#app'</span>),</span><br><span class="line">    props: () =&gt; Rx.Observable.of(&#123;</span><br><span class="line">        label: <span class="string">'Height'</span>,</span><br><span class="line">        unit: <span class="string">'cm'</span>,</span><br><span class="line">        min: <span class="number">100</span>,</span><br><span class="line">        max: <span class="number">220</span>,</span><br><span class="line">        init: <span class="number">170</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再來就是把 props 傳進去：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> state$ = model(upcomingValue$, sources.props);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>記住： props 也是 Observable</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">model</span>(<span class="params">upcomingValue$, props$</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> initValue$ = props$.map(props =&gt; props.init).first();</span><br><span class="line">    <span class="keyword">const</span> value$ = initValue$.concat(upcomingValue$);</span><br><span class="line">    <span class="keyword">const</span> state$ = Rx.Observable.combineLatest(value$, props$, </span><br><span class="line">        (value, props) =&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                label: props.label,</span><br><span class="line">                unit: props.unit,</span><br><span class="line">                min: props.min,</span><br><span class="line">                max: props.max,</span><br><span class="line">                value: value</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">return</span> state$</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>initial value 的 stream concat 新進來 value 的 stream，</p>
<p>取代原本的 <code>startWith</code></p>
<p>下一步就是把 label 的名字和單位給 return 出來，</p>
<p>變成一條 UI component 可以吃到的 state stream，</p>
<p>再把對應的值塞進 view 裡面，就能得到我們想要的 vtree$ 了。</p>
<h2 id="Using-component-with-Main-function"><a href="#Using-component-with-Main-function" class="headerlink" title="Using component with Main function"></a>Using component with Main function</h2><p>我們現在每個 component 中都會有個 main function，</p>
<p>事實上我們能把 main 改成這個 component 的名字，</p>
<p>並且在更上層的 main 中去使用它，</p>
<p>因為事實上他就是一個 function，在 functional programming 中，</p>
<p>“composable” 可以說是最重要的概念之一。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LabelSlider</span>(<span class="params">sources</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> upcomingValue$ = intent(sources.DOM);</span><br><span class="line">    <span class="keyword">const</span> state$ = model(upcomingValue$, sources.props);</span><br><span class="line">    <span class="keyword">const</span> vtree$ = view(state$);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        DOM: vtree$,</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span> (<span class="params">sources</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> LabelSlider(sources)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而事實上，我們可以把 props 這件事移到 main 中去做</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span> (<span class="params">sources</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> props$ = Rx.Observable.of(&#123;</span><br><span class="line">        label: <span class="string">'Height'</span>,</span><br><span class="line">        unit: <span class="string">'cm'</span>,</span><br><span class="line">        min: <span class="number">100</span>,</span><br><span class="line">        max: <span class="number">220</span>,</span><br><span class="line">        init: <span class="number">170</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> LabelSlider(&#123;DOM: sources.DOM, props: props$&#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> drivers = &#123;</span><br><span class="line">    DOM: makeDOMDriver(<span class="string">'#app'</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Multiple-Components"><a href="#Multiple-Components" class="headerlink" title="Multiple Components"></a>Multiple Components</h2><p>如果只有ㄧ個 component 的話，那 cycle.js 也太慘，</p>
<p>我們當然是可以組合多個 components，</p>
<p>只是該怎麼做呢？</p>
<p>很簡單，先把 sinks 個別抽出來：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span> (<span class="params">sources</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> weightProps$ = Rx.Observable.of(&#123;</span><br><span class="line">        label: <span class="string">'Weight'</span>,</span><br><span class="line">        unit: <span class="string">'kg'</span>,</span><br><span class="line">        min: <span class="number">30</span>,</span><br><span class="line">        max: <span class="number">220</span>,</span><br><span class="line">        init: <span class="number">70</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> weightSinks$ = LabelSlider(&#123;DOM: sources.DOM, props: weightProps$&#125;)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> heightProps$ = Rx.Observable.of(&#123;</span><br><span class="line">        label: <span class="string">'Height'</span>,</span><br><span class="line">        unit: <span class="string">'cm'</span>,</span><br><span class="line">        min: <span class="number">100</span>,</span><br><span class="line">        max: <span class="number">220</span>,</span><br><span class="line">        init: <span class="number">170</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">const</span> heightSinks$ = LabelSlider(&#123;DOM: sources.DOM, props: heightProps$&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> vtree$ = Rx.Observable.combineLatest(weightSinks$.DOM, heightSinks$.DOM, </span><br><span class="line">        (weightVtree, heightVtree) =&gt; </span><br><span class="line">        div([</span><br><span class="line">            weightVtree,</span><br><span class="line">            heightVtree</span><br><span class="line">            ]))</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        DOM: vtree$</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這裏會發現一個問題，就是當我們移動其中一個 slider 時，</p>
<p>另一個也會被影響 ，使用者的互動 =&gt; intent</p>
<p>因為兩個的 class 都是 slider，</p>
<p>而 intent 中監聽的又是 “.slider” 底下的 input。</p>
<p>其實我們在 LabelSlider 裡就可以讓兩條 stream 分流，</p>
<p>因為我們傳進去的 <code>sources.DOM</code>，是可以只要選取 weight 或 height 就好：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> weightSinks$ = LabelSlider(&#123;</span><br><span class="line">        DOM: sources.DOM.select(<span class="string">'.weight'</span>),</span><br><span class="line">        props: weightProps$</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>這裏做的事情就等於在 intent 裡面這樣：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">intent</span>(<span class="params">DOMSource</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> change$ = DOMSource.select(<span class="string">'.weight'</span>).select(<span class="string">'.slider'</span>).events(<span class="string">'input'</span>)</span><br><span class="line">        .map(ev =&gt; ev.target.value);</span><br><span class="line">    <span class="keyword">return</span> change$;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我們 <strong>pre-select</strong> 了在 DOM 上面 class name 為 ‘.weight’的 stream。</p>
<h1 id="Isolate-component"><a href="#Isolate-component" class="headerlink" title="Isolate component"></a>Isolate component</h1><ul>
<li><p><a href="https://github.com/cyclejs/isolate" target="_blank" rel="external">Isolate</a></p>
</li>
<li><p>要隔離開每個 Component 如果都像上面那樣做應該會瘋掉，<br>所以 Cyclejs 其實提供給我們一個 helper function： isolate</p>
</li>
<li><p>使用方法是傳入一個 Component function 當作 argument<br>再來會回傳一個 scoped 的 component function，<br>同樣吃 sources 進去，吐 sinks 出來</p>
</li>
<li><p><code>isolate(dataflowComponent, scope)</code>：第二個參數是 optional 的，如同看到的一樣</p>
</li>
</ul>
<blockquote>
<p>可能會有人覺得沒什麼差別，但如果單純使用 <code>isolate(dataflowComponent)</code>，</p>
<p>那會是一個不純的 function ，因為每次呼叫都會 return 一個不一樣的 scoped component function</p>
<p>但如果我們指定了 scope，那每次回來的就是同一個 scope 下的 component function</p>
<p>真正的濃醇香！</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> WeightSlider = isolate(LabelSlider, <span class="string">'weight'</span>);</span><br><span class="line"><span class="keyword">const</span> weightSinks$ = WeightSlider(&#123;</span><br><span class="line">    DOM: sources.DOM,</span><br><span class="line">    props: weightProps$</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> weightVtree$ = weightSinks$.DOM;</span><br></pre></td></tr></table></figure>
<p>如此一來又減少了一些 boiler plate</p>
<h2 id="Final-BMI"><a href="#Final-BMI" class="headerlink" title="Final BMI"></a>Final BMI</h2><p>目前缺的就是把 bmi 給算出來了，</p>
<p>首先我們知道這個運算會放在 main 裡面，</p>
<p>因為這就是這個簡單小 App 的主要<strong>邏輯</strong>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> bmi$ = Rx.Observable.combineLatest(weightValue$, heightValue$, (weight, height) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> heightMeters = height * <span class="number">0.01</span>;</span><br><span class="line">    <span class="keyword">const</span> bmi = <span class="built_in">Math</span>.round(weight/(heightMeters*heightMeters))</span><br><span class="line">    <span class="keyword">return</span> bmi;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>現在問題來了：我們要怎樣得到 weightValue$ 以及 heightValue$ 呢？</p>
<p>從 sources 拿啊！</p>
<p>概念很簡單，我們從 main 中拿到的 source，</p>
<p>其實就是從前一層 component 中吐出來的 sinks，</p>
<p>所以我們自然從前一層 component 中回傳的 sinks 下手：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LabelSlider</span>(<span class="params">sources</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> upcomingValue$ = intent(sources.DOM);</span><br><span class="line">    <span class="keyword">const</span> state$ = model(upcomingValue$, sources.props);</span><br><span class="line">    <span class="keyword">const</span> vtree$ = view(state$);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        DOM: vtree$,</span><br><span class="line">        value: state$.map(state=&gt; state.value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>實作起來也是這麼簡單。</p>
<p>最後我們回到 main 中，</p>
<p>把 bmi$ 也加進去就成啦！</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vtree$ = Rx.Observable.combineLatest(bmi$, weightVtree$, heightVtree$, (bmi, weightVtree, heightVtree) =&gt;</span><br><span class="line">        div([</span><br><span class="line">            weightVtree,</span><br><span class="line">            heightVtree,</span><br><span class="line">            h1(<span class="string">`BMI is: <span class="subst">$&#123;bmi&#125;</span>`</span>)</span><br><span class="line">        ]))</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        DOM: vtree$</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>總計 21 回的課程算不上太長，很推薦有興趣的人去把它看完，</p>
<p>儘管實際上要弄懂 Cycle.js 的概念的確需要花點時間，</p>
<p>但學習 FRP 是值得的，畢竟我們就是在處理 dataflow + UI，</p>
<p>再加上 pure function 好測試、composable 的特性，</p>
<p>不由得感慨 Rx 寫起來真是爽。</p>
<p>相較於 React，Cycle.js 當然更接近 functinoal programming，</p>
<p>不論這個東西將來會不會用到產品上，</p>
<p>純函數式的東西總會莫名的吸引我。</p>
<blockquote>
<p>如果要追求 fp，更應該要感受一下 <a href="http://elm-lang.org/" target="_blank" rel="external">elm</a></p>
</blockquote>
<p>這一堂課的影片幾乎都在 jsfiddle 上完成，</p>
<p>（不曉得作者為啥要這樣XD）</p>
<p>我中間練習的程式碼有放在 <a href="https://github.com/abalone0204/Learning-Cycle.js-By-Building-it" target="_blank" rel="external">github</a> 上面，</p>
<p>筆記等年假再來好好整理一番。</p>
<hr>
<h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><ul>
<li><p><a href="http://cycle.js.org/model-view-intent.html" target="_blank" rel="external">Official doc: Model View Intent</a></p>
</li>
<li><p><a href="http://www.codemag.com/Article/1601071" target="_blank" rel="external">How Functional Reactive Programming (FRP) is Changing the Face of Web Development</a></p>
</li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2016/04/24/simple-ci/" class="prev">PREV</a><a href="/2016/01/24/circle-js-2/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://abalone0204.github.com">Tsung-Chen Ku</a>, unless otherwise noted.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>