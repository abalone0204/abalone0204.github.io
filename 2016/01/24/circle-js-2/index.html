<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 做中學 Cycle.js（中） · De-bug</title><meta name="description" content="做中學 Cycle.js（中） - Tsung-Chen Ku"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="http://fonts.useso.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/abalone0204" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">做中學 Cycle.js（中）</h1><div class="post-time">Jan 24, 2016</div><div class="post-content"><p>Drivers 和一些簡單的例子</p>
<a id="more"></a>
<p>還沒看過上一篇的可以先去看上一篇了解 Cycle.js，</p>
<p>這一篇會從 driver 開始講。</p>
<p>drivers 是在控制畫面的 render，</p>
<p>但是我們目前的 driver 都是只能回傳字串，</p>
<p>這一章節我們要真的來認真的操作 DOM，</p>
<p>並且實作幾個小例子來看看 Cycle.js 這個框架是怎樣改變我們思考資料流的方式。</p>
<h2 id="Making-DOM-driver-more-flexible"><a href="#Making-DOM-driver-more-flexible" class="headerlink" title="Making DOM driver more flexible"></a>Making DOM driver more flexible</h2><p>這裏要來認真處理一下如何去從 object 去表示一個 DOM，</p>
<p>假如你之前實作過一個 Virtual DOM 的話，</p>
<p>我想會相當有幫助。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createElement</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> element = <span class="built_in">document</span>.createElement(obj.tagName);</span><br><span class="line">    obj.children</span><br><span class="line">            .filter(c =&gt; <span class="keyword">typeof</span> c === <span class="string">'object'</span>)</span><br><span class="line">            .map(createElement)</span><br><span class="line">            .forEach(c =&gt; element.appendChild(c));</span><br><span class="line">        obj.children</span><br><span class="line">            .filter(c =&gt; <span class="keyword">typeof</span> c === <span class="string">'string'</span>)</span><br><span class="line">            .forEach(c =&gt; element.innerHTML += c);</span><br><span class="line">    <span class="keyword">return</span> element;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>目前還只是沒加上 props 的簡化版。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">DOMDriver</span>(<span class="params">obj$</span>) </span>&#123;</span><br><span class="line">    obj$.subscribe(obj =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> container = <span class="built_in">document</span>.querySelector(<span class="string">'#app'</span>);</span><br><span class="line">        <span class="keyword">const</span> element = createElement(obj)</span><br><span class="line">        <span class="comment">// Refresh</span></span><br><span class="line">        container.innerHTML = <span class="string">''</span>;</span><br><span class="line">        container.appendChild(element);</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">const</span> DOMSource = Observable.fromEvent(<span class="built_in">document</span>, <span class="string">"click"</span>);</span><br><span class="line">    <span class="keyword">return</span> DOMSource</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這裏使用了 appendChild，所以如果不每次都清空的話，</p>
<p>等於每次都會 append 東西上來。</p>
<h2 id="在-DOM-source-掌控更多事情"><a href="#在-DOM-source-掌控更多事情" class="headerlink" title="在 DOM source 掌控更多事情"></a>在 DOM source 掌控更多事情</h2><p>回頭看一下我們的 Main，</p>
<p>發現我們唯一能從 DOM 拿到的 event stream，</p>
<p>居然只有 click$，這並不符合我們日常的開發情境，</p>
<p>現在就來解決這個問題。</p>
<p>解法很簡單，就是在 return DOMSource 的時候，</p>
<p>給個能夠選取 tag 和 event type 的 interface。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> DOMSource = &#123;</span><br><span class="line">    selectEvents: <span class="function"><span class="keyword">function</span>(<span class="params">tagName, eventType</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Observable.fromEvent(<span class="built_in">document</span>, eventType)</span><br><span class="line">            .filter(e =&gt; e.target.tagName === tagName.toUpperCase());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>這裏當然還是不夠 general 的版本，</p>
<p>不過這樣我們在 main function 裡面就能夠簡單的選取另一個 event 了。</p>
<h2 id="h"><a href="#h" class="headerlink" title="h()"></a>h()</h2><p>一開始我也很疑惑 h 是啥？</p>
<p>答案很簡單， “h” stands for html</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">function h(tagName, children) &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">        tagName,</span><br><span class="line">        children</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">function h1(children) &#123;</span><br><span class="line">    return h(&apos;H1&apos;, children);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>讓我們在 main 中要建造 elements 時省去不少力氣。</p>
<p>而 h1、h2、span⋯⋯等等你想得到的 tag，</p>
<p>都能藉由 function 來表示，</p>
<p>並且語法看起來也很簡單，</p>
<p>連我到後來都不禁思考：「<strong>我們真的需要 jsx 嗎</strong>？」</p>
<p>目前只是比較簡單的語法，還沒考慮到 properties，</p>
<p>在 main 中的長相大概會像這樣：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Observable.timer(<span class="number">0</span>, <span class="number">1000</span>)</span><br><span class="line">          .map(i =&gt;</span><br><span class="line">                h1([</span><br><span class="line">                    span([</span><br><span class="line">                        <span class="string">`Seconds elapsed <span class="subst">$&#123;i&#125;</span>`</span></span><br><span class="line">                    ])</span><br><span class="line">                ]))</span><br></pre></td></tr></table></figure>
<h2 id="Way-to-Real-Driver"><a href="#Way-to-Real-Driver" class="headerlink" title="Way to Real Driver"></a>Way to Real Driver</h2><p>處理完語法後，我們來看看怎樣寫出一個更 serious 一點的 driver。</p>
<p>第一個發現的問題就是我們又把整個 Component 要 mount 的地方寫死了，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">DOMDriver(obj$) =&gt; &#123;</span><br><span class="line">        obj$.subscribe(obj =&gt; &#123;</span><br><span class="line">            <span class="comment">// hard code</span></span><br><span class="line">            <span class="keyword">const</span> container = <span class="built_in">document</span>.querySelector(<span class="string">'#app'</span>);</span><br><span class="line">            <span class="keyword">const</span> element = createElement(obj)</span><br><span class="line">            container.innerHTML = <span class="string">''</span>;</span><br><span class="line">            container.appendChild(element);</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">const</span> DOMSource = &#123;</span><br><span class="line">            selectEvents: <span class="function"><span class="keyword">function</span>(<span class="params">tagName, eventType</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> Observable.fromEvent(<span class="built_in">document</span>, eventType)</span><br><span class="line">                    .filter(e =&gt; e.target.tagName === tagName.toUpperCase());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> DOMSource</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>這樣的寫法讓我們必須要在 DOM 上一定要有 id 為 app 的 element，</p>
<p>才能夠啟用 DOMDriver。</p>
<p>DOMDriver 是一個 function，</p>
<p>所以我們只要能回傳一個「客製化」的 function，</p>
<p>這件事情不就解決了嗎？</p>
<p>這裏運用到了 JavaScript 中「閉包(Closure)」的概念，</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeDOMDriver</span>(<span class="params">mountSelector</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (obj$) =&gt; &#123;</span><br><span class="line">        obj$.subscribe(obj =&gt; &#123;</span><br><span class="line">            <span class="keyword">const</span> container = <span class="built_in">document</span>.querySelector(mountSelector);</span><br><span class="line">            <span class="keyword">const</span> element = createElement(obj)</span><br><span class="line">            container.innerHTML = <span class="string">''</span>;</span><br><span class="line">            container.appendChild(element);</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">const</span> DOMSource = &#123;</span><br><span class="line">            selectEvents: <span class="function"><span class="keyword">function</span>(<span class="params">tagName, eventType</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> Observable.fromEvent(<span class="built_in">document</span>, eventType)</span><br><span class="line">                    .filter(e =&gt; e.target.tagName === tagName.toUpperCase());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> DOMSource</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> drivers = &#123;</span><br><span class="line">    DOM: makeDOMDriver(<span class="string">'#app'</span>),</span><br><span class="line">    Log: consoleLogDriver,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下一個問題則是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">container.innerHTML = <span class="string">''</span>;</span><br></pre></td></tr></table></figure>
<p>假如要 bind 到 DOM 上面是一個很大的 object，</p>
<p>那我們會遭遇到效能的問題。</p>
<p>再來則是 <code>selectEvents</code> 這個 function：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">selectEvents: <span class="function"><span class="keyword">function</span>(<span class="params">tagName, eventType</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>它只能指定 tagName，</p>
<p>不能用更方便的 selector 來選取想要的 element，</p>
<p>我們應該要提供一個更聰明一點的 API 來做這件事情。</p>
<p>關於這兩個問題點該怎麼重構，</p>
<p>作者並沒有詳細說明，但我們可以直接去看 source code，</p>
<p>這也是我們要將 CycleDOM import 進來的時候。</p>
<blockquote>
<p>小記一下，</p>
<p>假如我們繼續用舊有版本的 run，</p>
<p>那 <code>selectEvents</code> 會沒有被綁進去 source 裡面。</p>
<p>蠻好玩的，可以想一想要怎麼解這一個問題。</p>
</blockquote>
<p>接下來的正式引進 cycle-dom 中的 makeDOMDriver，</p>
<p>而原本的程式碼也要跟著做變動。</p>
<p>沒有意外的，首先需要更動的就是 selectEvents </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mouseover$ = sources.DOM.select(<span class="string">'span'</span>).events(<span class="string">'mouseover'</span>);</span><br></pre></td></tr></table></figure>
<p>這底下有一個 virtual dom來 handle 重繪，</p>
<p>不會像我們先前一樣，每次一有更動，</p>
<p>就重新 flush 整個畫面。</p>
<p>而 h1, h 也變得更加強大，可以試試看在第一個參數傳入物件，</p>
<p>可以自訂 attributes，以及調整 style。</p>
<h2 id="Hello-Wolrd"><a href="#Hello-Wolrd" class="headerlink" title="Hello Wolrd"></a>Hello Wolrd</h2><p>啊！終於要開始 Hello world 了，</p>
<p>跟以往不一樣的是我們已經跑了一次的底下大概會發生什麼事情，</p>
<p>才跟世界說 hello。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params">sources</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// return a sinks</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        DOM: Rx.Observable.of(</span><br><span class="line">            div([</span><br><span class="line">                label(<span class="string">'Name:'</span>),</span><br><span class="line">                input(<span class="string">'.field'</span>, &#123;</span><br><span class="line">                    type: <span class="string">"text"</span></span><br><span class="line">                &#125;),</span><br><span class="line">                hr(),</span><br><span class="line">                h1(<span class="string">'Hello !'</span>)</span><br><span class="line">            ]))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>現在我們用剛剛學到的 select跟 events 來處理一下 input 的 events。</p>
<p>注意到我們在 input function 那裏的第一個參數寫下 <code>.filed</code>，</p>
<p>會自動變成帶有 field class 的 input 。</p>
<p>（準確一點來說應該是 return 一個 virtual dom 的 element）</p>
<p>長這樣：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;tagName: <span class="string">"INPUT"</span>, properties: <span class="built_in">Object</span>, children: <span class="built_in">Array</span>[<span class="number">0</span>], key: <span class="literal">undefined</span>, namespace: <span class="literal">null</span>…&#125;</span><br></pre></td></tr></table></figure>
<p>再來則是把 input event 以及 值給拿出來：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> inputEv$ = sources.DOM.select(<span class="string">'.field'</span>).events(<span class="string">'input'</span>); </span><br><span class="line"><span class="keyword">const</span> name$ = inputEv$.map(ev =&gt; ev.target.value);</span><br></pre></td></tr></table></figure>
<p>再來要做的事情很直觀，</p>
<p>就是把 name$ 裏的值給 map 到 DOM 上面去……嗎？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">name$.map(name =&gt; </span><br><span class="line">        div([</span><br><span class="line">            label(<span class="string">'Name:'</span>),</span><br><span class="line">            input(<span class="string">'.field'</span>, &#123;</span><br><span class="line">                type: <span class="string">"text"</span></span><br><span class="line">            &#125;),</span><br><span class="line">            hr(),</span><br><span class="line">            h1(<span class="string">'Hello !'</span>)</span><br><span class="line">        ]))</span><br></pre></td></tr></table></figure>
<p>實際上這樣的作法會讓畫面上什麼都沒有，</p>
<p>因為 name$ 是 inputEv$ map 過後的結果，</p>
<p>而一開始 inputEv$ 是空的，自然沒有任何東西會 return 啦！</p>
<p>但要解決這個問題也很簡單，只需要<code>startWith</code>這個好用的 operator 即可。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params">sources</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> inputEv$ = sources.DOM.select(<span class="string">'.field'</span>).events(<span class="string">'input'</span>);</span><br><span class="line">    <span class="keyword">const</span> name$ = inputEv$</span><br><span class="line">        .map(ev =&gt; ev.target.value)</span><br><span class="line">        .startWith(<span class="string">'World'</span>);</span><br><span class="line">    <span class="comment">// return a sinks</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        DOM: name$.map(name =&gt;</span><br><span class="line">            div([</span><br><span class="line">                label(<span class="string">'Name:'</span>),</span><br><span class="line">                input(<span class="string">'.field'</span>, &#123;</span><br><span class="line">                    type: <span class="string">"text"</span></span><br><span class="line">                &#125;),</span><br><span class="line">                hr(),</span><br><span class="line">                h1(<span class="string">`Hello <span class="subst">$&#123;name&#125;</span>!`</span>)</span><br><span class="line">            ]))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Hello world 完成啦！</p>
<h2 id="Counter"><a href="#Counter" class="headerlink" title="Counter"></a>Counter</h2><p>在開始之前得提醒一下，</p>
<p>跟 Redux 在開發之前得先想好 StateTree 的道理有點像，</p>
<p>在 Cycle 中，我們會體會到要怎樣設計一個 Stream 的流向，</p>
<p>而 UI 只要跟著這個 Flow 去變化就行了</p>
<p>（狀態顯示為 Reactive 狂粉）</p>
<blockquote>
<p>來個經典的 Counter example 。</p>
</blockquote>
<p>廢話不多說，</p>
<p>就先把頁面和 increment 以及 decrement 的 click stream 弄出來：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params">sources</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> decrementClick$ = sources.DOM.select(<span class="string">'#decrement'</span>).events(<span class="string">'click'</span>);</span><br><span class="line">    <span class="keyword">const</span> incrementClick$=sources.DOM.select(<span class="string">'#increment'</span>).events(<span class="string">'click'</span>);</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        DOM: Rx.Observable.of(</span><br><span class="line">            div([</span><br><span class="line">                button(<span class="string">'#decrement'</span>, <span class="string">'Decrement'</span>),</span><br><span class="line">                button(<span class="string">'#increment'</span>, <span class="string">'Increment'</span>),</span><br><span class="line">                p([</span><br><span class="line">                    label(<span class="string">'0'</span>)</span><br><span class="line">                    ])</span><br><span class="line">                ])</span><br><span class="line">            )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>拿到 Stream 之後呢？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> decrementAction$ = decrementClick$.map(ev =&gt; <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">const</span> incrementAction$ = incrementClick$.map(ev =&gt; <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">const</span> number$ = Rx.Observable.of(<span class="number">0</span>)</span><br><span class="line">        .merge(decrementAction$)</span><br><span class="line">        .merge(incrementAction$);</span><br></pre></td></tr></table></figure>
<p>這裏並沒有得到我們想要的東西，</p>
<p>來看一下 merge stream 是怎樣運作的，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0---------------- number$</span><br><span class="line">--(-1)-(-1)------ decrementAction$</span><br><span class="line">-------------1---incrementAction$</span><br><span class="line">    [merge]</span><br><span class="line">0-(-1)-(-1)--1---[merged$]</span><br></pre></td></tr></table></figure>
<p>我們必須有個東西把 Stream 上所有的值給加總，</p>
<p>想到 array 的 reduce 了嗎？</p>
<p>其實 Rx 有提供一個 Operator 給我們做類似的操作：</p>
<p>它叫做 <code>scan</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> number$ = Rx.Observable.of(<span class="number">0</span>)</span><br><span class="line">        .merge(decrementAction$)</span><br><span class="line">        .merge(incrementAction$)</span><br><span class="line">        .scan((prev, cur) =&gt; prev+cur);</span><br></pre></td></tr></table></figure>
<p>Cycle 強迫我們在一開始就想好資料的流向，</p>
<p>以及事件的處理，如此我們在開發的時候能夠更深思熟慮一點，</p>
<p>不會讓整個 Project 變得很 crazy。</p>
<p>在簡單的 Counter 下這好處還不明顯，我目前也沒用 Cycle 寫過大型的產品，</p>
<p>所以且讓我們繼續看下去。</p>
<h2 id="Cycle-Http-Driver"><a href="#Cycle-Http-Driver" class="headerlink" title="Cycle Http Driver"></a>Cycle Http Driver</h2><p>開發 web，我們當然會需要送 http request，</p>
<p>所以我們就需要 http driver。</p>
<p>這裏我們要從 github 的 api 來拿 users 資料。</p>
<p>一樣先把基本的頁面弄出來</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params">sources</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        DOM: Rx.Observable.of(</span><br><span class="line">            div([</span><br><span class="line">                button(<span class="string">'.get_first'</span>, [<span class="string">'Get first user'</span>]),</span><br><span class="line">                div(<span class="string">'.user_details'</span>, [</span><br><span class="line">                    h1(<span class="string">'.user_name'</span>, <span class="string">'(name)'</span>),</span><br><span class="line">                    h4(<span class="string">'.email'</span>, <span class="string">'(email)'</span>),</span><br><span class="line">                    a(<span class="string">'.web'</span>, &#123;href: <span class="string">'google.com'</span>&#125;,<span class="string">'(url)'</span>)</span><br><span class="line">                    ])</span><br><span class="line">                ])</span><br><span class="line">            )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我們想讓使用者點下 get_first 的按鈕後，</p>
<p>就拿到 user 的資料。</p>
<p>前面有提到什麼是 read effect 跟 write effect，</p>
<p>effect 會因應 logics 規則的變化，真正影響到外在世界。</p>
<p>實際講起來太抽象了，我們現在把這個 App 中會發生的 effect 以及分類列出來，</p>
<p>會清楚很多：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DOM Read effect : button clicked</span><br><span class="line">HTTP Write effect: send request</span><br><span class="line">HTTP Read effect: receive response</span><br><span class="line">DOM Write effect: user&apos;s data displayed</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params">sources</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// DOM Read effect : button clicked</span></span><br><span class="line">    <span class="keyword">const</span> clickEv$ = sources.DOM</span><br><span class="line">        .select(<span class="string">'.get_user'</span>).events(<span class="string">'click'</span>);</span><br><span class="line">    <span class="comment">// HTTP Write effect: send request</span></span><br><span class="line">    <span class="keyword">const</span> request$ = clickEv$.map(_ =&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            url: API_URL,</span><br><span class="line">            method: <span class="string">'GET'</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// HTTP Read effect: receive response</span></span><br><span class="line">    <span class="keyword">const</span> response$$ = sources.HTTP</span><br><span class="line">        .filter(response$ =&gt; response$.request.url === API_URL)</span><br><span class="line">    <span class="keyword">const</span> response$ = response$$.<span class="keyword">switch</span>();</span><br><span class="line">    <span class="keyword">const</span> firstUser$ = response$.map(res =&gt; res.body)</span><br><span class="line">    .startWith(&#123;&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// DOM Write effect: user's data displayed</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        DOM: firstUser$.map(user =&gt;</span><br><span class="line">            div([</span><br><span class="line">                button(<span class="string">'.get_user'</span>, [<span class="string">'Get user'</span>]),</span><br><span class="line">                div(<span class="string">'.user_details'</span>, [</span><br><span class="line">                    h1(<span class="string">'.user_name'</span>, user.name),</span><br><span class="line">                    h4(<span class="string">'.email'</span>, user.email),</span><br><span class="line">                    a(<span class="string">'.web'</span>, &#123;</span><br><span class="line">                        href: user.url</span><br><span class="line">                    &#125;, user.url)</span><br><span class="line">                ])</span><br><span class="line">            ])</span><br><span class="line">        ),</span><br><span class="line">        HTTP: request$</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="BMI"><a href="#BMI" class="headerlink" title="BMI"></a>BMI</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params">sources</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> changeWeight$ = sources.select(<span class="string">'.weight'</span>).events(<span class="string">'input'</span>)</span><br><span class="line">        .map(ev =&gt; ev.target.value);</span><br><span class="line">    <span class="keyword">const</span> changeHeight$ = sources.select(<span class="string">'.height'</span>).events(<span class="string">'input'</span>)</span><br><span class="line">        .map(ev =&gt; ev.target.value);</span><br><span class="line">    <span class="comment">// Need to combine two $,</span></span><br><span class="line">    <span class="comment">// Like we use `zip` to arrays.</span></span><br><span class="line">    <span class="keyword">const</span> state$ = Rx.Observable.combineLatest(</span><br><span class="line">        changeWeight$,</span><br><span class="line">        changeHeight$, (weight, height) =&gt; &#123;</span><br><span class="line">            <span class="keyword">const</span> heightM = height/<span class="number">100</span>;</span><br><span class="line">            <span class="keyword">const</span> bmi = <span class="built_in">Math</span>.round(weight / (heightM * heightM));</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                bmi, weight, height</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        DOM: state$.map(state =&gt;</span><br><span class="line">            div([</span><br><span class="line">                div([</span><br><span class="line">                    label(<span class="string">`Weight: <span class="subst">$&#123;state.weight&#125;</span>kg`</span>),</span><br><span class="line">                    input(<span class="string">'.weight'</span>, &#123;</span><br><span class="line">                        type: <span class="string">'range'</span>,</span><br><span class="line">                        min: <span class="number">40</span>,</span><br><span class="line">                        max: <span class="number">150</span>,</span><br><span class="line">                        value: state.weight</span><br><span class="line">                    &#125;)</span><br><span class="line">                ]),</span><br><span class="line">                div([</span><br><span class="line">                    label(<span class="string">`Height: <span class="subst">$&#123;state.height&#125;</span>cm`</span>),</span><br><span class="line">                    input(<span class="string">'.height'</span>, &#123;</span><br><span class="line">                        type: <span class="string">'range'</span>,</span><br><span class="line">                        min: <span class="number">140</span>,</span><br><span class="line">                        max: <span class="number">250</span>,</span><br><span class="line">                        value: state.height</span><br><span class="line">                    &#125;)</span><br><span class="line"></span><br><span class="line">                ]),</span><br><span class="line">                h1(<span class="string">`BMI is <span class="subst">$&#123;state.bmi&#125;</span>`</span>)</span><br><span class="line">            ])</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在處理 Stream 時，往 Collection 的方向想會舒服很多，</p>
<p>因為我們處理 Array 也是如此，</p>
<p>最後一篇我們將會來看看 Cycle.js 怎樣提高我們程式碼的複用性，</p>
<p>學習用另一種方式去思考該怎樣拆解每個 Component。</p>
<hr>
<h1 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h1><ul>
<li><p><a href="http://openhome.cc/Gossip/JavaScript/Closure.html" target="_blank" rel="external">閉包</a></p>
</li>
<li><p><a href="https://medium.com/javascript-scene/master-the-javascript-interview-what-is-a-closure-b2f0d2152b36#.arfskyb6g" target="_blank" rel="external">Master the JavaScript Interview: What is a Closure?</a></p>
</li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2016/02/01/circle-js-3/" class="prev">PREV</a><a href="/2016/01/23/cycle-js-basic/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://abalone0204.github.com">Tsung-Chen Ku</a>, unless otherwise noted.</p></div></footer></div><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>